name: Build and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0 or v1.1.0-rc.1)'
        required: true
        default: 'v1.0.0'
      release_name:
        description: 'Release name'
        required: true
        default: 'RustFrame'
      prerelease:
        description: 'Is this a pre-release?'
        required: false
        type: boolean
        default: false
  push:
    tags:
      - 'v*'
      - '*.*.*'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

# Required permissions for creating releases
permissions:
  contents: write

jobs:
  build:
    name: Build Windows Executable
    runs-on: windows-latest
    
    steps:
      - name: Compute version variables
        shell: pwsh
        run: |
          # Figure out version source: workflow_dispatch input or tag name
          $versionInput = "${{ github.event.inputs.version }}"
          if ([string]::IsNullOrWhiteSpace($versionInput)) {
            $versionInput = "${{ github.ref_name }}"  # e.g. v1.1.0 or v1.1.0-rc.1
          }

          # Trim leading 'v' for Cargo.toml
          $versionTrim = $versionInput.TrimStart('v')

          # Release name (fallback)
          $releaseName = "${{ github.event.inputs.release_name }}"
          if ([string]::IsNullOrWhiteSpace($releaseName)) { $releaseName = "RustFrame" }

          # Determine prerelease: explicit input or inferred from hyphen in version (semver prerelease)
          $preInput = "${{ github.event.inputs.prerelease }}"
          if ([string]::IsNullOrWhiteSpace($preInput)) {
            $isPrerelease = $versionTrim.Contains('-')
          } else {
            $isPrerelease = [System.Convert]::ToBoolean($preInput)
          }

          "VERSION_INPUT=$versionInput" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "VERSION_TRIM=$versionTrim"   | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "RELEASE_NAME=$releaseName"  | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "IS_PRERELEASE=$isPrerelease"| Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Update version in Cargo.toml
        run: |
          $version = "${{ env.VERSION_TRIM }}"
          Write-Host "Setting version to: $version"
          
          # Read Cargo.toml
          $content = Get-Content "Cargo.toml" -Raw
          
          # Update version line
          $content = $content -replace 'version = "[^"]*"', "version = `"$version`""
          
          # Write back
          Set-Content "Cargo.toml" -Value $content -NoNewline
          
          Write-Host "‚úÖ Cargo.toml version updated to $version"
          Select-String -Path "Cargo.toml" -Pattern "^version"

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build release binary
        run: cargo build --release --verbose

      - name: Verify binary exists
        run: |
          if (Test-Path "target/release/RustFrame.exe") {
            Write-Host "‚úÖ RustFrame.exe found!"
            Get-Item "target/release/RustFrame.exe" | Format-List
          } else {
            Write-Error "‚ùå RustFrame.exe not found!"
            exit 1
          }

      - name: Create release package
        run: |
          # Create release directory
          New-Item -ItemType Directory -Force -Path "release-package"
          
          # Copy the executable
          Copy-Item "target/release/RustFrame.exe" -Destination "release-package/"
          
          # Copy manifest if exists
          if (Test-Path "RustFrame.exe.manifest") {
            Copy-Item "RustFrame.exe.manifest" -Destination "release-package/"
          }
          
          # Copy README
          if (Test-Path "README.md") {
            Copy-Item "README.md" -Destination "release-package/"
          }
          
          # Copy QUICK_START if exists
          if (Test-Path "QUICK_START.md") {
            Copy-Item "QUICK_START.md" -Destination "release-package/"
          }
          
          # Create ZIP archive
          Compress-Archive -Path "release-package/*" -DestinationPath "RustFrame-${{ env.VERSION_INPUT }}-windows-x64.zip"
          
          Write-Host "‚úÖ Release package created!"
          Get-ChildItem "RustFrame-${{ env.VERSION_INPUT }}-windows-x64.zip" | Format-List

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: RustFrame-${{ env.VERSION_INPUT }}-windows-x64
          path: |
            release-package/RustFrame.exe
            release-package/README.md
            release-package/QUICK_START.md
          retention-days: 30

      - name: Prepare release notes (from changelog if available)
        shell: pwsh
        run: |
          $versionInput = "${{ env.VERSION_INPUT }}"            # e.g., v1.2.3
          $versionTrim  = "${{ env.VERSION_TRIM }}"             # e.g., 1.2.3

          # Candidate changelog paths
          $paths = @(
            "docs/changelog/$versionInput.md",
            "docs/changelog/$versionTrim.md"
          )

          $changelog = $null
          foreach ($p in $paths) {
            if (Test-Path $p) { $changelog = $p; break }
          }

          if ($changelog) {
            Write-Host "Using changelog: $changelog"
            $content = Get-Content $changelog -Raw
          } else {
            Write-Host "Changelog not found for $versionInput; using default body"
            $content = @(
              "## RustFrame $versionInput",
              "",
              "### üì• Download",
              "Download `RustFrame-$versionInput-windows-x64.zip`, extract and run `RustFrame.exe`.",
              "",
              "### ‚ú® Highlights",
              "- GPU-accelerated screen capture using Windows.Graphics.Capture API",
              "- Adjustable frame overlay for precise region selection",
              "- Keyboard shortcuts for quick adjustments",
              "- Great for video conferencing screen sharing"
            ) -join "`n"
          }

          # Write release notes to file for action-gh-release body_path
          $content | Out-File -FilePath "release-notes.md" -Encoding utf8

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION_INPUT }}
          name: ${{ env.RELEASE_NAME }} - ${{ env.VERSION_INPUT }}
          body_path: release-notes.md
          draft: false
          prerelease: ${{ env.IS_PRERELEASE }}
          files: |
            RustFrame-${{ env.VERSION_INPUT }}-windows-x64.zip
            target/release/RustFrame.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
